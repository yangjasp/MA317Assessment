---
title: "MA317 Final Assignment: Life Expectancy"
author: ""
date: "14/12/2022"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r setup, include= FALSE}
knitr::opts_chunk$set(echo = TRUE) ################# what is this ????????????????????????????????

### load packages
library(ISLR)
library(tidyr)
library(dplyr)
library(ggplot2)
library(corrplot)
library(flextable)
library(mice)
library(faraway)
library(cowplot)
library(ggthemes)
library(ggsci)
library(miceadds)
library(officer)
library(multcomp)
library(car)

# Read in the data
LE_data_raw <- read.csv("Life_Expectancy_Data1.csv")
LE_data <- subset(LE_data_raw, select = -c(Country.Code,EG.FEC.RNEW.ZS)) #we deleted .. Renewable energy consumption because it had 100% missingness
LE_data$SP.POP.TOTL <- LE_data$SP.POP.TOTL/100000 # Change units of population to be more interpretable
LE_data$SH.HIV.INCD <- LE_data$SH.HIV.INCD/1000 # Change units of HIV adults to 1000s

m <- 10 # number of imputations
```

## Question 1

1. Exploratory Data Analysis: describe the data and deal with missing values
(a) Analyse using descriptive statistics (both graphical and numerical representations) and R the Life Expectancy data1.csv dataset. [12 marks]

```{r, echo = FALSE}
# First, we are going to analyze in broad strokes, the main characteristics of our data

# N obs
dim(LE_data) # 217 observations, 29 columns

# N missing for LE
table(is.na(LE_data$SP.DYN.LE00.IN))
table(is.na(LE_data$SP.DYN.LE00.IN))/nrow(LE_data) # percent missing


# Max and min values for life expectancy
# Max
max(LE_data$SP.DYN.LE00.IN, na.rm = TRUE)
dplyr::arrange(LE_data, desc(SP.DYN.LE00.IN))$Country.Name[1]
# min
min(LE_data$SP.DYN.LE00.IN, na.rm = TRUE)
dplyr::arrange(LE_data, SP.DYN.LE00.IN)$Country.Name[1]
```

```{r, echo = FALSE}
# Renaming our variables so it's easier to handle the data
# Names key
new_names <- c("Country.Name", "Continent", "life_expectancy",
               "electricity_access", "income_growth", "income_growth_pc",
               "children_HIV", "children_out_of_school",
               "ed_attain_primary_rate", "ed_attain_bach_rate",
               "infant_mortality_rate", "primary_completion_rate",
               "literacy_rate", "real_interest_rate", "pop_growth_perc_annual",
               "pop_dens", "pop_total", "health_expend_pc",
               "health_expend_perc_gdp", "unemployment_rate", "gdp_growth",
               "gdp_pc", "birth_rate", "adults_HIV", "safe_drinking_water",
               "poverty_ratio", "ed_duration")

names(LE_data) <- new_names
```

## Table by Continents
```{r, echo = FALSE, include = FALSE}
# Following the small exploration of data we're doing, we chose 4 areas (education, population density, health and wealth), and of course, life expectancy itself, on which we'll see how the different continents behave

## Split data by continent for table
LE_Africa <- dplyr::filter(LE_data, Continent == 'Africa')
LE_Asia <- dplyr::filter(LE_data, Continent == 'Asia') 
LE_Oceania <- dplyr::filter(LE_data, Continent == 'Australia/Oceania')
LE_Europe <- dplyr::filter(LE_data, Continent == 'Europe')
LE_NA <- dplyr::filter(LE_data, Continent == 'North America')
LE_SA <- dplyr::filter(LE_data, Continent == 'South America')


# Mean and standard deviation of the 5 variables we're studying 
# In order for us to visualize the data in a "easier" way, we're going summarize it in a table

## Life Expectancy
life_expectancy_Africa <- paste0(
  sprintf("%.1f",mean(LE_Africa$life_expectancy, na.rm = TRUE)), ' (', sprintf("%.1f", sd(LE_Africa$life_expectancy, na.rm = TRUE)), ")")
life_expectancy_Asia <- paste0(
  sprintf("%.1f",mean(LE_Asia$life_expectancy, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Asia$life_expectancy, na.rm = TRUE)), ")")
life_expectancy_Oceania <- paste0(
  sprintf("%.1f",mean(LE_Oceania$life_expectancy, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Oceania$life_expectancy, na.rm = TRUE)), ")")
life_expectancy_Europe <- paste0(
  sprintf("%.1f",mean(LE_Europe$life_expectancy, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Europe$life_expectancy, na.rm = TRUE)), ")")
life_expectancy_NA <- paste0(
  sprintf("%.1f",mean(LE_NA$life_expectancy, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_NA$life_expectancy, na.rm = TRUE)), ")")
life_expectancy_SA <- paste0(
  sprintf("%.1f",mean(LE_SA$life_expectancy, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_SA$life_expectancy, na.rm = TRUE)), ")")
life_expectancy_All <- paste0(
  sprintf("%.1f",mean(LE_data$life_expectancy, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_data$life_expectancy, na.rm = TRUE)), ")")
# Combine it to a vector
table1_life_expectancy <- c(life_expectancy_Africa,
                        life_expectancy_Asia,
                        life_expectancy_Oceania, 
                        life_expectancy_Europe,
                        life_expectancy_NA,
                        life_expectancy_SA,
                        life_expectancy_All)

## Primary Educational Attainment population aged 25+ (units by %)
primary_completion_Africa <- paste0(
  sprintf("%.1f",mean(LE_Africa$primary_completion_rate, na.rm = TRUE)), ' (', sprintf("%.1f", sd(LE_Africa$primary_completion_rate, na.rm = TRUE)), ")")
primary_completion_Asia <- paste0(
  sprintf("%.1f",mean(LE_Asia$primary_completion_rate, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Asia$primary_completion_rate, na.rm = TRUE)), ")")
primary_completion_Oceania <- paste0(
  sprintf("%.1f",mean(LE_Oceania$primary_completion_rate, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Oceania$primary_completion_rate, na.rm = TRUE)), ")")
primary_completion_Europe <- paste0(
  sprintf("%.1f",mean(LE_Europe$primary_completion_rate, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Europe$primary_completion_rate, na.rm = TRUE)), ")")
primary_completion_NA <- paste0(
  sprintf("%.1f",mean(LE_NA$primary_completion_rate, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_NA$primary_completion_rate, na.rm = TRUE)), ")")
primary_completion_SA <- paste0(
  sprintf("%.1f",mean(LE_SA$primary_completion_rate, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_SA$primary_completion_rate, na.rm = TRUE)), ")")
primary_completion_All <- paste0(
  sprintf("%.1f",mean(LE_data$primary_completion_rate, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_data$primary_completion_rate, na.rm = TRUE)), ")")
# Combine it to a vector
table1_primary_completion <- c(primary_completion_Africa,
                        primary_completion_Asia,
                        primary_completion_Oceania, 
                        primary_completion_Europe,
                        primary_completion_NA,
                        primary_completion_SA,
                        primary_completion_All)

## Population Density
pop_density_Africa <- paste0(
  sprintf("%.1f",mean(LE_Africa$pop_dens, na.rm = TRUE)), ' (', sprintf("%.1f", sd(LE_Africa$pop_dens, na.rm = TRUE)), ")")
pop_density_Asia <- paste0(
  sprintf("%.1f",mean(LE_Asia$pop_dens, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Asia$pop_dens, na.rm = TRUE)), ")")
pop_density_Oceania <- paste0(
  sprintf("%.1f",mean(LE_Oceania$pop_dens, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Oceania$pop_dens, na.rm = TRUE)), ")")
pop_density_Europe <- paste0(
  sprintf("%.1f",mean(LE_Europe$pop_dens, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Europe$pop_dens, na.rm = TRUE)), ")")
pop_density_NA <- paste0(
  sprintf("%.1f",mean(LE_NA$pop_dens, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_NA$pop_dens, na.rm = TRUE)), ")")
pop_density_SA <- paste0(
  sprintf("%.1f",mean(LE_SA$pop_dens, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_SA$pop_dens, na.rm = TRUE)), ")")
pop_density_All <- paste0(
  sprintf("%.1f",mean(LE_data$pop_dens, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_data$pop_dens, na.rm = TRUE)), ")")
# Combine it to a vector
table1_pop_density <- c(pop_density_Africa,
                        pop_density_Asia,
                        pop_density_Oceania, 
                        pop_density_Europe,
                        pop_density_NA,
                        pop_density_SA,
                        pop_density_All)

## Health Expenditure per Capita
health_expenditure_Africa <- paste0(
  sprintf("%.1f",mean(LE_Africa$health_expend_pc, na.rm = TRUE)), ' (', sprintf("%.1f", sd(LE_Africa$health_expend_pc, na.rm = TRUE)), ")")
health_expenditure_Asia <- paste0(
  sprintf("%.1f",mean(LE_Asia$health_expend_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Asia$health_expend_pc, na.rm = TRUE)), ")")
health_expenditure_Oceania <- paste0(
  sprintf("%.1f",mean(LE_Oceania$health_expend_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Oceania$health_expend_pc, na.rm = TRUE)), ")")
health_expenditure_Europe <- paste0(
  sprintf("%.1f",mean(LE_Europe$health_expend_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Europe$health_expend_pc, na.rm = TRUE)), ")")
health_expenditure_NA <- paste0(
  sprintf("%.1f",mean(LE_NA$health_expend_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_NA$health_expend_pc, na.rm = TRUE)), ")")
health_expenditure_SA <- paste0(
  sprintf("%.1f",mean(LE_SA$health_expend_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_SA$health_expend_pc, na.rm = TRUE)), ")")
health_expenditure_All <- paste0(
  sprintf("%.1f",mean(LE_data$health_expend_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_data$health_expend_pc, na.rm = TRUE)), ")")
# Combine it to a vector
table1_health_expenditure <- c(health_expenditure_Africa, 
                               health_expenditure_Asia, 
                               health_expenditure_Oceania, 
                               health_expenditure_Europe,
                               health_expenditure_NA,
                               health_expenditure_SA, 
                               health_expenditure_All)

## GDP per Capita
GDP_Africa <- paste0(
  sprintf("%.1f",mean(LE_Africa$gdp_pc, na.rm = TRUE)), ' (', sprintf("%.1f", sd(LE_Africa$gdp_pc, na.rm = TRUE)), ")")
GDP_Asia <- paste0(
  sprintf("%.1f",mean(LE_Asia$gdp_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Asia$gdp_pc, na.rm = TRUE)), ")")
GDP_Oceania <- paste0(
  sprintf("%.1f",mean(LE_Oceania$gdp_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Oceania$gdp_pc, na.rm = TRUE)), ")")
GDP_Europe <- paste0(
  sprintf("%.1f",mean(LE_Europe$gdp_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_Europe$gdp_pc, na.rm = TRUE)), ")")
GDP_NA <- paste0(
  sprintf("%.1f",mean(LE_NA$gdp_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_NA$gdp_pc, na.rm = TRUE)), ")")
GDP_SA <- paste0(
  sprintf("%.1f",mean(LE_SA$gdp_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_SA$gdp_pc, na.rm = TRUE)), ")")
GDP_All <- paste0(
  sprintf("%.1f",mean(LE_data$gdp_pc, na.rm = TRUE)), ' (', sprintf("%.1f",sd(LE_data$gdp_pc, na.rm = TRUE)), ")")
# Combine it to a vector
table1_GDP <- c(GDP_Africa, GDP_Asia, GDP_Oceania, GDP_Europe, GDP_NA, GDP_SA, GDP_All)

## Add ncountries
ncountries_Africa <- nrow(LE_Africa)
ncountries_Asia <- nrow(LE_Asia)
ncountries_Oceania <- nrow(LE_Oceania)
ncountries_Europe <- nrow(LE_Europe)
ncountries_NA <- nrow(LE_NA)
ncountries_SA <- nrow(LE_SA)
ncountries_All <- nrow(LE_data)
# Combine it to a vector
table1_ncountries <- c(ncountries_Africa, ncountries_Asia, ncountries_Oceania, ncountries_Europe, ncountries_NA, ncountries_SA, ncountries_All)

## Gather missingness % for each variable shown in table ??????????????????????????????????????????????? (we need to either use it or delete it)
life_expectancy_pmissing <- paste0(
  sprintf("%.1f",mean(is.na(LE_data$life_expectancy))*100), '%')

primary_completion_pmissing <- paste0(
  sprintf("%.1f",mean(is.na(LE_data$primary_completion_rate))*100), '%')

pop_density_pmissing <- paste0(
  sprintf("%.1f",mean(is.na(LE_data$pop_dens))*100), '%')

health_expenditure_pmissing <- paste0(
  sprintf("%.1f",mean(is.na(LE_data$health_expend_pc))*100), '%')

GDP_pmissing <- paste0(
  sprintf("%.1f",mean(is.na(LE_data$gdp_pc))*100), '%')


# Showing results

# Combining all the information
table1_df <- c()
table1_df$Continent <- c("Africa", "Asia", "Australia/Oceania", "Europe", "North America", "South America", "Total")
table1_df$ncountries <- table1_ncountries
table1_df$Life_expectancy <- table1_life_expectancy
table1_df$primary_completion <- table1_primary_completion
table1_df$health_expenditure <- table1_health_expenditure
table1_df$pop_density <- table1_pop_density
table1_df$GDP <- table1_GDP

# Setting the tittles for the table
table1_df <- as.data.frame(table1_df)
names(table1_df) <- c("Continent",
                      "Number of Countries",
                      "Life Expectancy at Birth (years)",
                      "Primary School Completion Rate (total of % by age)", 
                      "Health Expenditure (current international $)",
                      "Population Density (people per sq. km)",
                      "GDP per Capita (current international $)")

# Table properties
table1_table <- flextable(table1_df, col_keys = names(table1_df))
 
table1_table <- align(table1_table,j =1, align = "left", part = "all")
table1_table <- align(table1_table,j = 2:7, align = "right", part = "all")
table1_table <- width(table1_table, width = c(1.4,1.0,1.0,1.0,1.0,1.0, 1.0))
table1_table <- hrule(table1_table, rule = "at least", part = "all")
table1_table <- hline(table1_table, i = 6, j = NULL, part = "body", 
                      border = fp_border(color="black"))

table1_table <- footnote(table1_table, j = 1, i = 1, part="body",  value = as_paragraph("Mean (SD)" ))
table1_table <- footnote(table1_table, j = 1, i = 2, part="body",  value = as_paragraph(paste0(
 "Value reported from complete cases only. Missingness present for each variable at the following rates: ",
  "Life Expectancy ", life_expectancy_pmissing, ";",
  "Primary Education Completion ", primary_completion_pmissing, ";",
 "Health Expenditure ", health_expenditure_pmissing, ";",
  "Population Density ", pop_density_pmissing, ";",
  "GDP ", GDP_pmissing, ".")))


# Final table
table1_table
```

## Table of Variables with Missingness over 50%
```{r, echo = FALSE}
# We're going to analinse the missingness of our data since we noticed a lot is missing

# Loop to get the number of missing values
x <- c()
for (i in 1:ncol(LE_data))
{
  x[i] = mean(is.na(LE_data[,i])) # quantity
  names(x)[i] = names(LE_data)[i] # variable
}

# We're splitting the data into low and high missing values
# Low
low_missing <- x[x < 0.5] # we're using a 50% missingness
low_missing_vars = names(low_missing)
# High
high_missing <- x[x >= 0.5]
high_missing_vars <- names(high_missing)

# Writing the correct title names. Plus, note we also manually added the variable with 100% missingness to the table after generation
high_missing_vars_clean <- c("Children newly infected with HIV",
                             "Educational attainment, primary",
                             "Educational attainment, bachelor's",
                             "Literacy rate", "Poverty Ratio")

# Loop to get table values
high_missing_char <- c()
for (i in 1:length(high_missing))
{
  high_missing_char[i] <- paste0(sprintf("%.1f", high_missing[i]*100),"%")
}

# Combining all the information
table2_df <- c()
table2_df$Var <- high_missing_vars_clean
table2_df$nmissing <- high_missing_char

# Setting the tittles for the table
table2_df <- as.data.frame(table2_df)
names(table2_df) <- c("Variables", "Missingness")

# Table properties
table2_table <- flextable(table2_df, col_keys = names(table2_df))

table2_table <- align(table2_table,j =1, align = "left", part = "all")
table2_table <- align(table2_table,j = 2, align = "right", part = "all")
table2_table <- width(table2_table, width = c(1.4,1.4))
table2_table <- hrule(table2_table, rule = "at least", part = "all")

# Final table
table2_table # Note, we also manually added the variable with 100% missingness to the table after generation
```

## Some graphs for out variable of interest: LE
```{r, echo = FALSE}
# Continuing with the exploratory analysis, we are plotting some useful results

## Plot 1: Histogram of life expectancy
p1 <- ggplot(LE_data, aes(life_expectancy)) +
  geom_histogram(color = "#000000", fill = "#0099F8") +
  theme_bw()+
  xlab("Life Expectancy (Years)")+
  ylab("Frequency")+ 
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm"))

## Plot 2: boxplot by Health Spending quantiles
# Setting the quantiles
health_expend_quantiles <- quantile(LE_data$health_expend_perc_gdp, c(0.25, 0.5, 0.75), na.rm = TRUE)
temp <- LE_data %>%
  dplyr::mutate(HE_quantile = case_when(
    health_expend_perc_gdp < health_expend_quantiles[1] ~ "0-25%",
    health_expend_perc_gdp < health_expend_quantiles[2] ~ "25-50%",
    health_expend_perc_gdp < health_expend_quantiles[3] ~ "50-75%",
    health_expend_perc_gdp >= health_expend_quantiles[3] ~ "70-100%")) %>%
  dplyr::filter(!(is.na(health_expend_perc_gdp)))
# Plotting
p2 <- ggplot(temp, aes(x = HE_quantile, y = life_expectancy, 
                 color = HE_quantile)) +
  geom_boxplot(show.legend = FALSE) +
  ggsci::scale_color_jama()+
  theme(axis.text.x = element_text(angle = 45))+
  theme_bw()+
  xlab("Health expenditure per capita (% GDP) quantile")+
  ylab("Life Expectancy (Years)") + 
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm"))

## Plot 3: Healthcare per capita (plus visualization of size per continent)
p3 <- ggplot(data = LE_data, aes(x = gdp_pc, 
                                 y = life_expectancy))+
  geom_point(aes(size = pop_total, color = Continent),
             show.legend = c(TRUE))  + 
  ggsci::scale_color_jama()+
  scale_x_log10() + 
  theme_bw()+
  ylab("Life Expectancy (Years)") +
  xlab("GDP Per Capita ($)") +
  guides(size = "none") +
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm"))

# Plot in a grid with cowplot::plot_grid() and also give titles
top <- cowplot::plot_grid(p1, p2, labels = c("A. Histogram of Life Expectancy", "B. Life Expectancy by Healthcare Spending"),
                          hjust = -0.1)
bottom <- cowplot::plot_grid(p3, labels = c("C. Life Expectancy by Population and GDP per capita"),
                             hjust = -0.1)
cowplot::plot_grid(top, bottom, ncol = 1)
```

```{r}
# Also plot life exp, health expenditure per capita for Figure S1 (to show we need to log-transform)
p1 <- ggplot(data = LE_data, aes(x = health_expend_pc, 
                                 y = life_expectancy))+
  geom_point()  + 
  ggsci::scale_color_jama()+
  theme_bw()+
  ylab("Life Expectancy (Years)") +
  xlab("Health spending per capita ($)") +
  guides(size = "none") +
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm"))
p2 <- ggplot(data = LE_data, aes(x = health_expend_pc, 
                                 y = life_expectancy))+
  geom_point()  + 
  ggsci::scale_color_jama()+
  scale_x_log10() + 
  theme_bw()+
  ylab("Life Expectancy (Years)") +
  xlab("log(Health spending per capita)") +
  guides(size = "none") +
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm"))

cowplot::plot_grid(p1,p2,nrow = 1)

# Log-transform GDP per capita and health_expend_pc in dataset
LE_data$gdp_pc <- log(LE_data$gdp_pc)
LE_data$health_expend_pc <- log(LE_data$health_expend_pc)
```

(b) Many predictors in the dataset contain missing values. Is deleting predictor variables with many missing values an appropriate method to deal with missing values? Choose a method to deal with the missing values and then employ this method to the life expectancy data. Justify your choice. Additionally, there are some countries (cases) where the value of Life expectancy is missing. Explain how you will handle this problem. [13 marks]

```{r, echo = FALSE}
# Dealing with missing data

# Subset variables with missingness < 50%
LE_data1 <- LE_data[ ,names(LE_data) %in% low_missing_vars]
Country.Name <- LE_data$Country.Name

# Remove ID column for imputation
LE_data2 <- subset(LE_data1, select = -c(Country.Name))
```

```{r, echo = FALSE, results = 'hide'}
# We are using the mice package, which multiple imputation by chained equations.
#?mice() to access documentation

# First, we create predictor matrix without LE, so LE isn't used to predict covariates.
pred <- mice::make.predictorMatrix(LE_data2)
pred[,"life_expectancy"] <- 0 # never use it as a predictor

# Imputation using method predictive mean matching (pmm) and m = 10 iterations
imputations <- mice(LE_data2, seed = 98, predictorMatrix = pred, method = "pmm", m = 10)
```

```{r, echo = FALSE}
# stipplot() as we used in lab did not seem to work for some reason.
# So we plot the imputed and observed values for a subset of features manually.
# For this, we just chose a somewhat random subset of features that covered different
# levels of missingness


# Countries missing life expectancy data
countries_missing_gdp_pc <- dplyr::filter(LE_data, is.na(gdp_pc))$Country.Name
countries_missing_health_expend_pc <- dplyr::filter(LE_data, is.na(health_expend_pc))$Country.Name
countries_missing_safe_drinking_water <- dplyr::filter(LE_data, 
                                                        is.na(safe_drinking_water))$Country.Name
countries_missing_infant_mortality_rate <- dplyr::filter(LE_data, 
                                                         is.na(infant_mortality_rate))$Country.Name

# We will only plot first 5 imputations so it is easy to see. Extract first 5 imputed datasets
vars <- c("life_expectancy", "adults_HIV", "health_expend_pc", "infant_mortality_rate") 
imp1 <- cbind(LE_data$Country.Name,"imp" = 1, complete(imputations, 1))
imp2 <- cbind(LE_data$Country.Name,"imp" = 2, complete(imputations, 2))
imp3 <- cbind(LE_data$Country.Name,"imp" = 3, complete(imputations, 3))
imp4 <- cbind(LE_data$Country.Name,"imp" = 4, complete(imputations, 4))
imp5 <- cbind(LE_data$Country.Name,"imp" = 5, complete(imputations, 5))
imps <- rbind(imp1, imp2, imp3, imp4, imp5)

# Re-add country name, which we had removed before imputing.
# Also define new variable specifying which points were imputed
names(imps)[1] <- "Country.Name"
imps <- imps %>%
  dplyr::mutate(Type_gdp = ifelse(Country.Name %in% countries_missing_gdp_pc,
                                  "Imputed", "Not Imputed"),
                Type_safe_drinking = ifelse(Country.Name %in% countries_missing_safe_drinking_water,
                                  "Imputed", "Not Imputed"),
                Type_health = ifelse(Country.Name %in% countries_missing_health_expend_pc,
                                  "Imputed", "Not Imputed"),
                Type_infant = ifelse(Country.Name %in% countries_missing_infant_mortality_rate,
                                  "Imputed", "Not Imputed"))

p1 <- ggplot(arrange(imps, desc(Type_gdp)), aes(x = imp, 
                       y = gdp_pc,
                       color = Type_gdp)) +
  geom_point(size = 0.8, shape = 1,
             show.legend = FALSE) + 
  theme_bw()+ 
  scale_color_manual(values = c("#8B0000", "#FFFF00")) + 
  xlab("Imputation") + 
  ylab("log(GDP per capita)")

p3 <- ggplot(arrange(imps, desc(Type_safe_drinking)), aes(x = imp, 
                       y = safe_drinking_water,
                       color = Type_safe_drinking)) +
  geom_point(shape = 1, size = 0.8, show.legend = FALSE) +
  theme_bw()+ 
  scale_color_manual(values = c("#8B0000", "#FFFF00")) + 
  xlab("Imputation") + 
  ylab("Safe drinking water (%)")

p2 <- ggplot(arrange(imps, desc(Type_health)), aes(x = imp, 
                       y = health_expend_pc,
                       color = Type_health)) +
  geom_point(shape = 1, size = 0.8, show.legend = FALSE) +
  theme_bw()+ 
  scale_color_manual(values = c("#8B0000", "#FFFF00")) + 
  xlab("Imputation") + 
  ylab("log(Health expenditure per capita)")

p4 <- ggplot(arrange(imps, desc(Type_infant)), aes(x = imp, 
                       y = infant_mortality_rate,
                       color = Type_infant)) +
  geom_point(shape = 1, size = 0.8, show.legend = FALSE) +
  theme(axis.title.y = element_text(size = 9)) + 
  theme_bw()+ 
  scale_color_manual(values = c("#8B0000", "#FFFF00")) + 
  xlab("Imputation") + 
  ylab("Infant mortality rate (per 1,000 live births)")

cowplot::plot_grid(p1, p2, p3, p4, nrow = 2, hjust = -0.1)
```

2. Collinearity increases the variance of the estimators and hence, reduces the adequacy of the model. When collinearity is present, how do you solve this problem? Investigate collinearity between the predictor variables in the LifeExpectancyData1.csv dataset. [12 marks]

```{r, echo = FALSE}
# Studying collinearity presence, which we can do on multiply imputed data using
# the 'miceadds' package
#?miceadds

# First, we are calculating correlations by removing Continent (factor) and life expectancy (response)
mi_corr <- micombine.cor(imputations, variables = c(3:21))

# This gives pairwise correlations in columns. We're now turning it into a matrix (for plotting, analysis)
cor_df <- mi_corr %>%
  dplyr::select(variable1, variable2, r) %>%
  tidyr::pivot_wider(names_from = variable2, values_from = r)

# Rearranging columns and making diagonals 1 instead of NA
cor_df <- cor_df %>%
  dplyr::relocate(electricity_access, .before = income_growth)  %>%
  dplyr::mutate_all(~replace(., is.na(.), 1))

# Lastly, move var names from col 1 into row names
cor_df <- as.data.frame(cor_df)
rownames(cor_df) <- cor_df$variable1
cor_df <- cor_df[,-1]

  
# Plot

# Set names for corplot printing
colnames(cor_df) <-  c("Electricity access", "Income growth",
                       "Income growth percent", "Children out of school",
                       "Infant mortality rate", "Primary completion rate",
                       "Real interest rate", "Percent pop. growth",
                       "Pop. density", "Total pop.",
                       "Health spending per capita",
                       "Health spending perc. GDP",
                       "Unemployment rate", "GDP growth",
                       "GDP per capita", "Birth rate",
                       "Adults HIV perc.", "Safe drinking water",
                       "Education duration")
rownames(cor_df) <- colnames(cor_df)

# and plot
corrplot(as.matrix(cor_df),tl.cex = 0.8, tl.col="black")


# I dont think it is really cleat what the vif function is doing so i didnt know how to comment it ???????????????????????????????????????????

# Variance inflation factors (VIF). Find mean over imputations initially.
# Since we didn't learn a clear way to calculate VIF on multiply imputed datasets (and don't
# see one in 'miceadds'),
# we instead calculate it on each one individually and then report the mean VIF for each variable
# across the 10 datasets
vif_output <- list()
for (i in 1:10)
{
  vif_output[[i]] <- faraway::vif(complete(imputations, i)[,-c(1,2)])
}

vif_output_means <- c()
for (i in 1:length(vif_output[[1]]))
{
  val_vec <- c()
  for (j in 1:10)
  {
    val_vec[j] <- vif_output[[j]][i]
  }
  vif_output_means[i] <- mean(val_vec)
  names(vif_output_means)[i] <- names(vif_output[[1]][i])
}

# VIF. Find mean over imputations after
vif_output_means

# These are the variables with large VIFs and high pairwise correlations w/ other vars 
drop_vars <- c("Continent","life_expectancy","income_growth","birth_rate", "electricity_access", "health_expend_pc")

# Now recalculate VIFs after dropping the drop_vars
vif_output_after <- list()
for (i in 1:10)
{
  vif_output_after[[i]] <- faraway::vif(complete(imputations, i)[,!(names(complete(imputations, i)) %in% drop_vars)])
}

vif_output_means_after <- c()
for (i in 1:length(vif_output_after[[1]]))
{
  val_vec_after <- c()
  for (j in 1:10)
  {
    val_vec_after[j] <- vif_output_after[[j]][i]
  }
  vif_output_means_after[i] <- mean(val_vec_after)
  names(vif_output_means_after)[i] <- names(vif_output_after[[1]][i])
}

# Now we see lower means
vif_output_means_after
```

```{r}
# VIF table

# Somehow this table isn't printing the VIF after, but we manually added the values to the table
# from the above "vif_output_means_after"!

temp <- data.frame("Feature" = names(vif_output_means_after),
                   "VIF After Dropping Vars" = vif_output_means_after)

tableS1_df <- data.frame("Feature" = colnames(cor_df),
                         "VIF" = sprintf("%.2f",vif_output_means))
tableS1_df <- dplyr::left_join(tableS1_df, temp, by = "Feature")%>%
  dplyr::mutate(VIF.After.Dropping.Vars = 
                  ifelse(is.na(VIF.After.Dropping.Vars),
                         " ",
                         sprintf("%.2f", VIF.After.Dropping.Vars)))

names(tableS1_df)[3] <- "VIF After Dropping Vars"


tableS1_table <- flextable(tableS1_df)

tableS1_table <- align(tableS1_table,j =1, align = "left", part = "all")
tableS1_table <- align(tableS1_table,j =2:3, align = "right", part = "all")
tableS1_table <- width(tableS1_table, width = c(1.4,1.0, 1.0))
#table1_table <- height_all(table1_table,height = 0.30)
tableS1_table <- hrule(tableS1_table, rule = "at least", part = "all")
tableS1_table
```


3. To understand better life expectancy and the factors that affect it, suggest the best linear model which predicts life expectancy in 2020. Interpret and evaluate the suggested model. [25 marks]

```{r, echo = FALSE, results = 'hide'}
#Defining the analysis we're performing. Only include subset of variables (without drop_vars)
feature.selection1 <- expression(null.model1 <- lm(life_expectancy ~ 1), model2 <- step(null.model1, scope = ~  income_growth_pc + children_out_of_school + infant_mortality_rate + primary_completion_rate + real_interest_rate + pop_growth_perc_annual + pop_dens + pop_total + health_expend_perc_gdp + unemployment_rate + gdp_growth + gdp_pc + adults_HIV + safe_drinking_water + ed_duration, direction = "forward"))

# Redefine list of imputations to remove life expectancy for countries
# with NA life expectancy originally. We don't want to use them here - only in predictions later
countries_with_LE <- dplyr::filter(LE_data,
                                   !(is.na(life_expectancy)))$Country.Name


imp_filt <- mice::filter(imputations, 
                         Country.Name %in% countries_with_LE)

# Using the with function to evaluate the above expression
step.fit <- with(imputations, feature.selection1)

# Extracting the number of times each variable appears in the m imputed datasets
step.fit <- with(imp_filt, feature.selection1)
step.fit.models <- lapply(step.fit$analyses, formula)
step.fit.features <- lapply(step.fit.models, terms)
feature.frequency <- unlist(lapply(step.fit.features, labels))
```

Stepwise feature selection with our imputed datasets yields the following table showing the frequency of feature selection:

```{r, echo = FALSE}
sort(table(feature.frequency), decreasing=TRUE)

# Pool results according to above model (using mice, like we did in lab)
fit <- with(imp_filt, lm(life_expectancy ~ 
         health_expend_perc_gdp + infant_mortality_rate + safe_drinking_water + pop_dens + 
         gdp_pc))

fit$analyses %>% str(max.level = 1)
  
pooled_results <- mice::pool(fit)
summary(pooled_results)
pool.r.squared(pooled_results, adjusted = TRUE)
```

```{r, echo = FALSE}

# Create table showing output
m <- 10
df <- as.data.frame(summary(pooled_results))
table3_df <- c()
table3_df$Feature <- c("Intercept",
                        "Health Expenditure (% GDP)", 
                       "Infant mortality rate",
                       "% drinking safe water",
                       "Population density (per sq. km)",
                       "log(GDP per capita)")
table3_df$Estimate <- sprintf("%.4f", df$estimate)
table3_df$SE <- sprintf("%.5f", df$std.error)
table3_df$df <- sprintf("%.2f", df$df)
table3_df$P_val <- sprintf("%.4f", df$p.value)
table3_df$P_val <- ifelse(table3_df$P_val == "0.0000",
                          "< 0.0001", table3_df$P_val)
table3_df$BestSubsetFrequency <- c(" ",
  table(feature.frequency)[names(table(feature.frequency)) == "health_expend_perc_gdp"]/m,
  table(feature.frequency)[names(table(feature.frequency)) == "infant_mortality_rate"]/m,
  table(feature.frequency)[names(table(feature.frequency)) == "safe_drinking_water"]/m,
  table(feature.frequency)[names(table(feature.frequency)) == "pop_dens"]/m,
  table(feature.frequency)[names(table(feature.frequency)) == "gdp_pc"]/m
)

# recalculate VIF for these five vars only
vif_output <- list()
for (i in 1:10){
  vif_output[[i]] <- faraway::vif(dplyr::select(
    complete(imputations, i), health_expend_perc_gdp,
    infant_mortality_rate,
     safe_drinking_water, pop_dens, gdp_pc))
}
vif_output_means2 <- c()
for (i in 1:length(vif_output[[1]])){
  val_vec <- c()
  for (j in 1:10){
    val_vec[j] <- vif_output[[j]][i]
  }
  vif_output_means2[i] <- mean(val_vec)
  names(vif_output_means2)[i] <- names(vif_output[[1]][i])
}
vif_output_means2
table3_df$VIF <- c(" ",vif_output_means2)
table3_df <- as.data.frame(table3_df)


names(table3_df) <- c("Feature",
                      "Estimate",
                      "Standard Error",
                      "df",
                      "P-value",
                      "Proportion of Best Subsets Appeared in",
                      "VIF")

table3_table <- flextable(table3_df, col_keys = c("Feature",
                      "Estimate",
                      "Standard Error",
                      "df",
                      "P-value",
                      "Proportion of Best Subsets Appeared in",
                      "VIF"))

table3_table <- align(table3_table,j =1, align = "left", part = "all")
table3_table <- align(table3_table,j =2:7, align = "right", part = "all")
table3_table <- width(table3_table, width = c(1.4,1.0, 1.1, 1.3, 1.0, 1.0, 1.0 ))
table3_table <- hrule(table3_table, rule = "at least", part = "all")
table3_table <- vline(table3_table, i = NULL, j = 5, part = "body", 
                      border = fp_border(color="black"))
table3_table
```


```{r, echo = FALSE}

# Extract residuals to check model assumptions.
# We will do this for each imputed dataset individually and report averages. 
# Should be ok with m = 10. A little higher and we might start to worry about CLT.
predict_df <- cbind(
  predict(fit$analyses[[1]], newdata = complete(imputations, 1)),
  predict(fit$analyses[[2]], newdata = complete(imputations, 2)),
  predict(fit$analyses[[3]], newdata = complete(imputations, 3)),
  predict(fit$analyses[[4]], newdata = complete(imputations, 4)),
  predict(fit$analyses[[5]], newdata = complete(imputations, 5)),
  predict(fit$analyses[[6]], newdata = complete(imputations, 6)),
  predict(fit$analyses[[7]], newdata = complete(imputations, 7)),
  predict(fit$analyses[[8]], newdata = complete(imputations, 8)),
  predict(fit$analyses[[9]], newdata = complete(imputations, 9)),
  predict(fit$analyses[[10]], newdata = complete(imputations, 10)))

observed_df <- cbind(
  dplyr::select(complete(imputations, 1), life_expectancy),
  dplyr::select(complete(imputations, 2), life_expectancy),
  dplyr::select(complete(imputations, 3), life_expectancy),
  dplyr::select(complete(imputations, 4), life_expectancy),
  dplyr::select(complete(imputations, 5), life_expectancy),
  dplyr::select(complete(imputations, 6), life_expectancy),
  dplyr::select(complete(imputations, 7), life_expectancy),
  dplyr::select(complete(imputations, 8), life_expectancy),
  dplyr::select(complete(imputations, 9), life_expectancy),
  dplyr::select(complete(imputations, 10), life_expectancy))

residual_df <- predict_df - observed_df # Note that residual_df has 15 columns (one for each imp) and 217  rows (one per obs).
names(residual_df) <- c(1:10)


# Now we find the mean for each obs and use that for residual diagnostic plots.
residual_means <- residual_df %>%
  dplyr::mutate(mean =rowMeans(residual_df))
residual_means <- residual_means[,"mean"]

# And do same for fit (for residual vs fit)
predicted_means <- as.data.frame(predict_df) %>%
  dplyr::mutate(mean = rowMeans(predict_df))
predicted_means <- predicted_means[,"mean"]

mean_df <- as.data.frame(cbind(predicted_means, residual_means))


# Plot

p1 <- ggplot(mean_df, aes(x=residual_means))+
  geom_histogram() + ggsci::scale_colour_jama() + 
  theme_bw() + theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm")) + 
  xlab("Residuals") + 
  ylab("Count")

p2 <- ggplot(mean_df, aes(sample = residual_means)) +
  stat_qq() + stat_qq_line() + theme_bw()+ 
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm")) +
  xlab("Theoretical") +
  ylab("Sample")

p3 <- ggplot(mean_df, aes(x=predicted_means, y = residual_means))+
  geom_point() + theme_bw() + 
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm")) +
  xlab("Fitted Value")+
  ylab("Residual")

# Plot's titles and format
top <- plot_grid(p1, p2, labels = c("A. Histogram of Residuals", "B. QQplot of Residuals"),
                 hjust = -0.1)
bottom <- plot_grid(p3, labels = "C. Residuals vs. Fit", hjust = -0.1)
plot_grid(top, bottom, nrow = 2)

```


```{r, echo = FALSE}
# Generate predictions for the 19 countries initially missing LE and print results in table

# First re-add Country Name variable to each imputed dataset
datalist <- list(cbind(LE_data$Country.Name, complete(imputations,1)),
                 cbind(LE_data$Country.Name, complete(imputations,2)),
                 cbind(LE_data$Country.Name, complete(imputations,3)),
                 cbind(LE_data$Country.Name, complete(imputations,4)),
                 cbind(LE_data$Country.Name, complete(imputations,5)),
                 cbind(LE_data$Country.Name, complete(imputations,6)),
                 cbind(LE_data$Country.Name, complete(imputations,7)),
                 cbind(LE_data$Country.Name, complete(imputations,8)),
                 cbind(LE_data$Country.Name, complete(imputations,9)),
                 cbind(LE_data$Country.Name, complete(imputations,10)))

# And filter to only keep 
datalist2 <- list()
for (i in 1:length(datalist)){
  names(datalist[[i]])[1] <- "Country.Name"
  datalist2[[i]] <- dplyr::filter(datalist[[i]], 
                                  Country.Name %in% countries_missing_LE)
} 

# Now predict over each one using coefficients from pooled model
# We aren't aware of an easy way to use 'predict()' on a model output by mice,
# so we perform predictions for estimates manually using the pooled coefficient estimates.
coefs <- pooled_results$pooled$estimate
pred_list <- list()

for (i in 1:length(datalist2)){
  df <- datalist2[[i]]
  pred_list[[i]] <- coefs[1] + coefs[2]*df$health_expend_perc_gdp +
    coefs[3]*df$infant_mortality_rate + coefs[4]*df$safe_drinking_water+
    coefs[5]*df$pop_dens + coefs[6]*df$gdp_pc
}

# Take mean of prediction for each countrry across imputed datasets
final_preds <- cbind(datalist2[[1]]$Country.Name, bind_cols(pred_list))

names(final_preds) = c("Country.Name",c("A1","A2",
                                        "A3", "A4",
                                        "A5", "A6",
                                        "A7","A8",
                                        "A9", "A10"))
  
final_preds <- dplyr::mutate(final_preds,
                             mean_pred = 
                               rowMeans(dplyr::select(final_preds, starts_with("A"))))

# Now plot
tableS2_df <- dplyr::select(final_preds, Country.Name, mean_pred) %>%
  dplyr::mutate(mean_pred = sprintf("%.2f", mean_pred))

names(tableS2_df) <- c("Country", "Predicted life expectancy")


tableS2_table <- flextable(tableS2_df, 
                           col_keys = c("Country", 
                                        "Predicted life expectancy"))

tableS2_table <- align(tableS2_table,j =1, align = "left", part = "all")
tableS2_table <- align(tableS2_table,j =2, align = "right", part = "all")
tableS2_table <- width(tableS2_table, width = c(1.4,1.0))
#table1_table <- height_all(table1_table,height = 0.30)
tableS2_table <- hrule(tableS2_table, rule = "at least", part = "all")
tableS2_table
```

4. Using the same dataset and using the additional feature Continent, employ an appropriate experimental design to study differences of average life expectancies across the continents: Asia, Europe, North America, South America, Africa, Australia/Oceania. Justify your choice of experimental design and methods. [13 marks]


```{r, echo = FALSE}
# Performing ANOVA III
anova_LE <- aov(life_expectancy ~ as.factor(Continent), data=complete(imputations))
summary(anova_LE)
Anova(anova_LE, type = "III")

# This specific section of code wasn't from lab. 
# We used this R-bloggers post for reference [5] here: 
# https://www.r-bloggers.com/2021/07/how-to-perform-ancova-in-r/
```

```{r, echo = FALSE}
# We just pick complete(imputations, 1) as our single imputation
anova_data <- complete(imputations, 1)
anova_data$Continent <- as.factor(anova_data$Continent)

# Performing ANCOVA (according to slides from Lecture 10)
le.aov <- aov(life_expectancy ~ log(gdp_pc) + Continent, data = anova_data)
summary(le.aov)

# Post-hoc test
tukey.le <- glht(le.aov, linfct = mcp(Continent = "Tukey"))

# view a summary of the post-hoc comparisons
summary(tukey.le)

# Note: we also trried re-running above code using complete(imputations, i)
# With i = 2,3,...,10 as sensitivity analysis and got similar results
```

Before proceeding with the statistical tests, we check the assumptions of ANCOVA which are (show diagnostic plots in appendix):

```{r, echo = FALSE}
# Plot life expectancy by % of GDP spent on healthcare
p1 <- ggplot(anova_data, aes(x = log(gdp_pc), y = life_expectancy, color = Continent)) +
  theme_bw() + 
  geom_point(alpha = 0.5, size = 0.8) + xlab("log(GDP per capita in thousands)")+
  ylab("Life expectancy") + ggsci::scale_color_jama() + geom_smooth(method="lm",se = FALSE)

# Figure showing life expectancy by continent (with singly imputed dataset that we will use)
p2 <- ggplot(complete(imputations, 1), aes(x = Continent, y = life_expectancy, color = Continent)) +
  geom_boxplot(show.legend = FALSE) + ggsci::scale_color_jama() + theme_bw() + theme(axis.text.x = element_text(angle = -45),
        plot.margin = unit(c(1,0.5,0.5,0.5), "cm")) + xlab("Continent") + ylab("Life Expectancy (Years)") 

plot_grid(p1, p2, labels = c("A", "B"))
```

```{r, echo = FALSE}
# Test for homogeneity of variances
car::leveneTest(anova_data$life_expectancy~anova_data$Continent)
```

* Normality of residuals
* Equal variances between the different continents

```{r}
# Analysing residual's normality assumptions
anova_data$residuals <- le.aov$residuals

# Plot 1
p1 <- ggplot(anova_data, aes(residuals)) +
  geom_histogram(color = "#000000", fill = "#0099F8") +
  theme_bw()+
  xlab("Residual")+
  ylab("Frequency")+ 
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm"))

# Plot 2
p2 <- ggplot(anova_data, aes(sample = residuals)) +
  stat_qq() +
  stat_qq_line() + 
  theme_bw()+ 
  theme(plot.margin = unit(c(1,0.5,0.5,0.5), "cm")) +
  xlab("Theoretical") +
  ylab("Sample")

plot_grid(p1, p2, labels = c("A.", "B"))

# Shapiro test
shapiro.test(anova_data$residuals) 
```